<!DOCTYPE html>
<html lang="es-CL">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Administración guiada de Helpin</title>
  <link rel="stylesheet" href="css/styles.css" />
  <style>
    .wizard-layout {
      display: grid;
      grid-template-columns: minmax(180px, 220px) minmax(0, 1fr);
      gap: 24px;
    }

    .wizard-secondary-nav {
      position: sticky;
      top: 96px;
      align-self: start;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
      border-radius: 16px;
      background: #fff;
      box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
    }

    .wizard-secondary-nav button {
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: transparent;
      padding: 10px 12px;
      border-radius: 12px;
      text-align: left;
      cursor: pointer;
      font-weight: 600;
      color: #0f172a;
    }

    .wizard-secondary-nav button.active {
      background: #0f172a;
      color: #fff;
    }

    .wizard-content {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .wizard-stepper {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    .wizard-stepper-item {
      border-radius: 14px;
      padding: 12px 14px;
      background: #f8fafc;
      border: 1px solid rgba(15, 23, 42, 0.08);
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      color: #0f172a;
    }

    .wizard-stepper-item .step-number {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #0f172a;
      color: #fff;
      display: grid;
      place-items: center;
      font-size: 0.9rem;
    }

    .wizard-stepper-item.active {
      background: #0f172a;
      color: #fff;
    }

    .wizard-stepper-item.active .step-number {
      background: #fff;
      color: #0f172a;
    }

    .wizard-step {
      display: none;
      padding: 24px;
      border-radius: 18px;
      background: #fff;
      box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
    }

    .wizard-step.active {
      display: block;
    }

    .wizard-step header {
      margin-bottom: 16px;
    }

    .wizard-actions {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      margin-top: 24px;
      flex-wrap: wrap;
    }

    .wizard-actions .primary {
      min-width: 160px;
    }

    .wizard-actions .secondary {
      min-width: 120px;
    }

    .template-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .template-buttons button {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, 0.16);
      background: #fff;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .wizard-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }

    .wizard-metrics .metric-card {
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      border: 1px solid rgba(15, 23, 42, 0.08);
    }

    .metric-title {
      font-size: 0.85rem;
      color: #64748b;
      margin-bottom: 4px;
    }

    .metric-value {
      font-size: 1.4rem;
      font-weight: 700;
      color: #0f172a;
    }

    .metric-subtitle {
      font-size: 0.85rem;
      color: #64748b;
    }

    .validation-hint {
      font-size: 0.85rem;
      color: #64748b;
      margin-top: 8px;
    }

    .validation-hint.error {
      color: #b91c1c;
    }

    .tests-grid {
      display: grid;
      gap: 12px;
    }

    .test-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(15, 23, 42, 0.1);
      background: #f8fafc;
    }

    .test-item header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .test-status {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
    }

    .test-status.ok {
      background: rgba(34, 197, 94, 0.16);
      color: #166534;
    }

    .test-status.warning {
      background: rgba(234, 179, 8, 0.18);
      color: #854d0e;
    }

    .test-status.fail {
      background: rgba(239, 68, 68, 0.16);
      color: #991b1b;
    }

    .summary-grid {
      display: grid;
      gap: 8px;
      margin-top: 16px;
    }

    .summary-grid span {
      font-size: 0.85rem;
      color: #64748b;
    }

    .activation-panel {
      display: grid;
      gap: 16px;
    }

    .activation-conditions {
      display: grid;
      gap: 8px;
    }

    .activation-conditions li {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.1);
      font-size: 0.75rem;
      font-weight: 600;
      color: #0f172a;
    }

    .advanced-details {
      border-radius: 12px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      padding: 12px 16px;
      background: #f8fafc;
    }

    .advanced-details summary {
      cursor: pointer;
      font-weight: 600;
      color: #0f172a;
    }

    .employee-chat-note {
      font-size: 0.8rem;
      color: #64748b;
      margin-top: 4px;
    }

    .wizard-checklist {
      display: grid;
      gap: 8px;
      margin-top: 16px;
    }

    .wizard-checklist .checklist-item {
      background: #f8fafc;
      border: 1px solid rgba(15, 23, 42, 0.1);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .wizard-checklist .checklist-item.completed {
      border-color: rgba(34, 197, 94, 0.6);
      background: rgba(34, 197, 94, 0.1);
    }

    .wizard-checklist .checkmark {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid rgba(15, 23, 42, 0.3);
      display: grid;
      place-items: center;
      font-size: 0.75rem;
      font-weight: 700;
      color: rgba(15, 23, 42, 0.6);
    }

    @media (max-width: 960px) {
      .wizard-layout {
        grid-template-columns: 1fr;
      }

      .wizard-secondary-nav {
        position: static;
        flex-direction: row;
        overflow-x: auto;
      }
    }
  </style>
</head>
<body class="admin-ui">
  <header class="admin-topbar">
    <div class="topbar-logo">Helpin</div>
    <div class="topbar-actions">
      <div class="save-status" id="saveStatus" aria-live="polite">✓ Guardado</div>
      <div>
        <a class="topbar-button small" id="employeeChatLink" href="chat.html" target="_blank" rel="noopener noreferrer">Ver como colaborador</a>
        <div class="employee-chat-note">Vista de prueba (no afecta datos reales).</div>
      </div>
    </div>
  </header>
  <main class="page wizard-layout">
    <aside class="wizard-secondary-nav" aria-label="Navegación secundaria">
      <button type="button" class="active" data-step-link="1">Paso 1 · Conocimiento</button>
      <button type="button" data-step-link="2">Paso 2 · Contacto RR. HH.</button>
      <button type="button" data-step-link="3">Paso 3 · Probar</button>
      <button type="button" data-step-link="4">Paso 4 · Activar</button>
    </aside>

    <div class="wizard-content">
      <section class="card">
        <div class="section-header">
          <h2>Panel resumido</h2>
          <p>Solo lo esencial para confirmar que el asistente está listo.</p>
        </div>
        <div class="wizard-metrics">
          <div class="metric-card">
            <div class="metric-title">Estado</div>
            <div class="metric-value" id="assistantStatusValue">Inactivo</div>
            <div class="metric-subtitle" id="assistantStatusSubtitle">Listo para activar cuando RR. HH. lo apruebe</div>
          </div>
          <div class="metric-card" id="sensitiveCard">
            <div class="metric-title">Consultas sensibles</div>
            <div class="metric-value" id="sensitiveCount">—</div>
            <div class="metric-subtitle">Revisar esta semana</div>
          </div>
          <div class="metric-card">
            <div class="metric-title">Última actualización del conocimiento</div>
            <div class="metric-value" id="knowledgeStatusValue">Vacía</div>
            <div class="metric-subtitle" id="knowledgeStatusSubtitle">Sin actualizaciones</div>
          </div>
        </div>
        <div class="wizard-checklist" id="setupChecklist">
          <button class="checklist-item" type="button" data-step-link="1" data-check-key="knowledge">
            <span class="checkmark" aria-hidden="true">✓</span>
            <span class="checklist-title">Cargar políticas y contenidos oficiales</span>
          </button>
          <button class="checklist-item" type="button" data-step-link="2" data-check-key="hr">
            <span class="checkmark" aria-hidden="true">✓</span>
            <span class="checklist-title">Definir contacto y escalamiento RR. HH.</span>
          </button>
          <button class="checklist-item" type="button" data-step-link="3" data-check-key="preview">
            <span class="checkmark" aria-hidden="true">✓</span>
            <span class="checklist-title">Probar preguntas sensibles en vista previa</span>
          </button>
          <button class="checklist-item" type="button" data-step-link="4" data-check-key="activation">
            <span class="checkmark" aria-hidden="true">✓</span>
            <span class="checklist-title" id="activationChecklistText">Activar el asistente para colaboradores</span>
          </button>
        </div>
      </section>

      <div class="wizard-stepper" aria-label="Progreso del asistente">
        <div class="wizard-stepper-item active" data-step="1">
          <span class="step-number">1</span>
          <span>Pegar conocimiento</span>
        </div>
        <div class="wizard-stepper-item" data-step="2">
          <span class="step-number">2</span>
          <span>Contacto RR. HH.</span>
        </div>
        <div class="wizard-stepper-item" data-step="3">
          <span class="step-number">3</span>
          <span>Probar</span>
        </div>
        <div class="wizard-stepper-item" data-step="4">
          <span class="step-number">4</span>
          <span>Activar</span>
        </div>
      </div>

      <section class="wizard-step active" data-step="1">
        <header>
          <h2>Paso 1 · Base de conocimiento</h2>
          <p>Pegue la información oficial que el asistente podrá usar para responder.</p>
        </header>
        <div class="template-buttons" aria-label="Plantillas de contenido">
          <button type="button" data-template="vacaciones">Insertar plantilla: Vacaciones</button>
          <button type="button" data-template="licencias">Insertar plantilla: Licencias</button>
          <button type="button" data-template="beneficios">Insertar plantilla: Beneficios</button>
          <button type="button" data-template="horarios">Insertar plantilla: Horarios</button>
          <button type="button" data-template="reglamento">Insertar plantilla: Reglamento</button>
        </div>
        <div class="knowledge-editor">
          <label class="sr-only" for="knowledgeContent">Contenido de conocimiento</label>
          <textarea
            id="knowledgeContent"
            placeholder="Pegue aquí políticas internas, beneficios, procedimientos y textos oficiales de RR. HH."
          ></textarea>
          <div class="knowledge-status" id="knowledgeStatus">Sin contenido aún</div>
          <div class="validation-hint">Última actualización: <span id="knowledgeUpdatedAt">Sin registro</span></div>
        </div>
        <div class="wizard-actions">
          <span class="badge" id="knowledgeProgress">Pendiente</span>
          <button class="primary" type="button" data-next-step="2">Continuar</button>
        </div>
      </section>

      <section class="wizard-step" data-step="2">
        <header>
          <h2>Paso 2 · Contacto RR. HH.</h2>
          <p>Defina cómo escalar preguntas sensibles o casos especiales.</p>
        </header>
        <div class="form-grid">
          <div>
            <label for="hrEmail">Correo de RR. HH.</label>
            <input id="hrEmail" type="text" placeholder="ejemplo@empresa.com" />
            <div class="validation-hint" id="hrEmailHint">Campo obligatorio.</div>
          </div>
          <div>
            <label for="hrUrl">URL de contacto de RR. HH. (opcional)</label>
            <input id="hrUrl" type="text" placeholder="https://intranet.empresa.com/rrhh" />
          </div>
        </div>
        <div class="card">
          <h3>Este será el canal de escalamiento</h3>
          <p class="note">Variables disponibles para mensajes: <strong>{correo_rrhh}</strong> y <strong>{url_rrhh}</strong>.</p>
          <p id="hrEscalationPreview">Se usará el correo y la URL definidos.</p>
        </div>
        <div class="wizard-actions">
          <button class="secondary" type="button" data-prev-step="1">Volver</button>
          <button class="primary" type="button" data-next-step="3">Continuar</button>
        </div>
      </section>

      <section class="wizard-step" data-step="3">
        <header>
          <h2>Paso 3 · Vista previa y pruebas guiadas</h2>
          <p>Revise la experiencia y ejecute pruebas con un clic.</p>
        </header>
        <div id="previewChat" class="preview-chat"></div>
        <div class="card">
          <div class="card-header">
            <div>
              <h3>Pruebas guiadas</h3>
              <p>Ejecute preguntas frecuentes y sensibles con semáforo de resultados.</p>
            </div>
            <button class="secondary small" type="button" id="runAllTests">Ejecutar todas las pruebas</button>
          </div>
          <div class="tests-grid" id="testsGrid"></div>
          <div class="summary-grid" id="testsSummary">
            <span>Total pruebas ejecutadas: <strong id="testsExecuted">0</strong></span>
            <span>OK: <strong id="testsOk">0</strong> · Warning: <strong id="testsWarning">0</strong> · Fail: <strong id="testsFail">0</strong></span>
          </div>
        </div>
        <div class="wizard-actions">
          <button class="secondary" type="button" data-prev-step="2">Volver</button>
          <button class="primary" type="button" data-next-step="4">Continuar</button>
        </div>
      </section>

      <section class="wizard-step" data-step="4">
        <header>
          <h2>Paso 4 · Activar</h2>
          <p>Revise los mínimos y habilite el asistente cuando todo esté listo.</p>
        </header>
        <div class="activation-panel">
          <div class="card">
            <h3>Requisitos mínimos</h3>
            <ul class="activation-conditions" id="activationConditions">
              <li><span class="checkmark">✓</span> Base de conocimiento cargada</li>
              <li><span class="checkmark">✓</span> Correo de RR. HH. válido</li>
              <li><span class="checkmark">✓</span> (Recomendado) Al menos 1 prueba ejecutada</li>
            </ul>
            <div class="validation-hint" id="activationHint">Complete los requisitos para activar.</div>
            <button class="primary" type="button" id="activateAssistant">Activar asistente</button>
            <button class="secondary small" type="button" id="deactivateAssistant">Desactivar</button>
          </div>

          <div class="card">
            <h3>Perfil de límites del asistente</h3>
            <p class="note">Seleccione el nivel de restricción para respuestas sensibles.</p>
            <div class="form-grid">
              <div>
                <label for="boundaryProfile">Perfil</label>
                <select id="boundaryProfile">
                  <option value="strict">Estricto (recomendado)</option>
                  <option value="custom">Personalizado</option>
                </select>
              </div>
            </div>
            <div class="settings-options" id="boundaryOptions">
              <label class="option-row">
                <span class="option-label">Responder solo con información oficial pegada por RR. HH.</span>
                <input id="boundaryOfficialOnly" class="toggle-input" type="checkbox" />
                <span class="toggle-switch" aria-hidden="true"></span>
              </label>
              <label class="option-row">
                <span class="option-label">No responder casos personales</span>
                <input id="boundaryPersonal" class="toggle-input" type="checkbox" />
                <span class="toggle-switch" aria-hidden="true"></span>
              </label>
              <label class="option-row">
                <span class="option-label">No interpretar contratos</span>
                <input id="boundaryContracts" class="toggle-input" type="checkbox" />
                <span class="toggle-switch" aria-hidden="true"></span>
              </label>
              <label class="option-row">
                <span class="option-label">No responder consultas legales</span>
                <input id="boundaryLegal" class="toggle-input" type="checkbox" />
                <span class="toggle-switch" aria-hidden="true"></span>
              </label>
              <label class="option-row">
                <span class="option-label">Sugerir siempre contactar a RR. HH. para excepciones</span>
                <input id="boundaryEscalate" class="toggle-input" type="checkbox" />
                <span class="toggle-switch" aria-hidden="true"></span>
              </label>
            </div>
          </div>

          <div class="card">
            <h3>Mensajes al colaborador</h3>
            <div class="form-grid">
              <div>
                <label for="noInfoMessage">Mensaje cuando no hay info o es caso especial (derivar a RR. HH.)</label>
                <textarea id="noInfoMessage"></textarea>
              </div>
              <div>
                <label for="assistantDisclaimer">Nota general (disclaimer corto)</label>
                <textarea id="assistantDisclaimer"></textarea>
              </div>
            </div>
            <p class="note">Use {correo_rrhh} y {url_rrhh} para personalizar el mensaje.</p>
            <div class="validation-hint" id="messagePreview"></div>
          </div>

          <details class="advanced-details" id="advancedOptions">
            <summary>Avanzado (opcional)</summary>
            <div class="form-grid" style="margin-top: 12px;">
              <div>
                <label for="countryContext">País o marco laboral de referencia</label>
                <select id="countryContext">
                  <option value="Chile">Chile</option>
                  <option value="España">España</option>
                  <option value="Francia">Francia</option>
                  <option value="Polonia">Polonia</option>
                  <option value="Genérico">Genérico</option>
                </select>
              </div>
              <div>
                <label>Tono (opcional)</label>
                <div class="segmented-control" role="radiogroup" aria-label="Tono">
                  <label class="segment">
                    <input type="radio" name="tone" value="Neutral" />
                    <span>Neutral</span>
                  </label>
                  <label class="segment">
                    <input type="radio" name="tone" value="Formal" />
                    <span>Formal</span>
                  </label>
                  <label class="segment">
                    <input type="radio" name="tone" value="Amable" />
                    <span>Amable</span>
                  </label>
                </div>
                <p class="note">El tono es opcional y no afecta las políticas oficiales.</p>
              </div>
              <div>
                <label>Idiomas disponibles</label>
                <div class="language-options">
                  <label class="language-option">
                    <input type="checkbox" name="assistantLanguage" value="Español" />
                    <span>Español</span>
                  </label>
                  <label class="language-option">
                    <input type="checkbox" name="assistantLanguage" value="Inglés" />
                    <span>Inglés</span>
                  </label>
                  <label class="language-option">
                    <input type="checkbox" name="assistantLanguage" value="Francés" />
                    <span>Francés</span>
                  </label>
                  <label class="language-option">
                    <input type="checkbox" name="assistantLanguage" value="Alemán" />
                    <span>Alemán</span>
                  </label>
                  <label class="language-option">
                    <input type="checkbox" name="assistantLanguage" value="Portugués" />
                    <span>Portugués</span>
                  </label>
                </div>
              </div>
            </div>
          </details>
        </div>
        <div class="wizard-actions">
          <button class="secondary" type="button" data-prev-step="3">Volver</button>
          <button class="primary" type="button" data-next-step="1">Ir al inicio</button>
        </div>
      </section>
    </div>
  </main>

  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="js/mockData.js"></script>
  <script src="js/router.js"></script>
  <script src="js/chat.js"></script>
  <script>
    (function () {
      const data = window.HelpinData;
      let isDirty = false;
      let saveTimer = null;
      let activeStep = 1;
      let previewReviewed = false;
      let testsExecuted = 0;
      const testsState = new Map();

      const strictProfileValues = {
        onlyOfficialInfo: true,
        noPersonalCases: true,
        noContractInterpretation: true,
        noLegalQuestions: true,
        alwaysEscalate: true
      };

      const templates = {
        vacaciones: `## Vacaciones\n- Requisitos de elegibilidad\n- Días disponibles y acumulación\n- Procedimiento para solicitar\n- Casos especiales y excepciones`,
        licencias: `## Licencias\n- Licencias médicas\n- Licencias parentales\n- Documentación requerida\n- Tiempos de respuesta`,
        beneficios: `## Beneficios\n- Beneficios de salud\n- Beneficios de bienestar\n- Seguros o coberturas\n- Requisitos para acceder`,
        horarios: `## Horarios\n- Horario general\n- Flexibilidad/teletrabajo\n- Registro de asistencia\n- Cambios de turno`,
        reglamento: `## Reglamento interno\n- Normas de convivencia\n- Código de conducta\n- Procedimientos disciplinarios\n- Canal de dudas`
      };

      const tests = [
        {
          id: 'vacaciones',
          label: 'Vacaciones: ¿Cuántos días de vacaciones tengo al año?',
          type: 'common'
        },
        {
          id: 'licencias',
          label: 'Licencias: ¿Cómo solicito una licencia médica?',
          type: 'common'
        },
        {
          id: 'beneficios',
          label: 'Beneficios: ¿Qué beneficios de salud ofrece la empresa?',
          type: 'common'
        },
        {
          id: 'horarios',
          label: 'Horarios: ¿Cuál es el horario estándar?',
          type: 'common'
        },
        {
          id: 'permisos',
          label: 'Permisos: ¿Puedo pedir un permiso especial?',
          type: 'common'
        },
        {
          id: 'salud',
          label: 'Caso sensible: Necesito apoyo por un tema de salud personal.',
          type: 'sensitive'
        },
        {
          id: 'conflicto',
          label: 'Caso sensible: Tengo un conflicto con mi jefe directo.',
          type: 'sensitive'
        },
        {
          id: 'legal',
          label: 'Caso sensible: ¿Qué dice mi contrato sobre cláusulas especiales?',
          type: 'sensitive'
        },
        {
          id: 'negociacion',
          label: 'Caso sensible: Necesito una excepción o negociación de beneficios.',
          type: 'sensitive'
        },
        {
          id: 'datos',
          label: 'Caso sensible: ¿Cómo puedo actualizar mis datos personales?',
          type: 'sensitive'
        }
      ];

      function updateSaveStatus() {
        const status = document.querySelector('#saveStatus');
        if (!status) {
          return;
        }
        if (isDirty) {
          status.textContent = 'Cambios sin guardar';
          status.classList.add('unsaved');
        } else {
          status.textContent = '✓ Guardado';
          status.classList.remove('unsaved');
        }
      }

      function markDirty() {
        isDirty = true;
        updateSaveStatus();
        if (saveTimer) {
          window.clearTimeout(saveTimer);
        }
        saveTimer = window.setTimeout(() => {
          isDirty = false;
          updateSaveStatus();
        }, 1200);
      }

      function formatDate(value) {
        if (!value) {
          return 'Sin registro';
        }
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) {
          return 'Sin registro';
        }
        return date.toLocaleString('es-CL', {
          dateStyle: 'medium',
          timeStyle: 'short'
        });
      }

      function updateKnowledgeStatus() {
        const status = document.querySelector('#knowledgeStatus');
        const updatedAt = document.querySelector('#knowledgeUpdatedAt');
        const content = data.knowledgeContent || '';

        if (status) {
          status.textContent = content.trim().length > 0
            ? 'Contenido listo para usar.'
            : 'Sin contenido aún';
        }
        if (updatedAt) {
          updatedAt.textContent = formatDate(data.knowledgeUpdatedAt);
        }
        updateStatusCards();
      }

      function updateStatusCards() {
        const assistantStatusValue = document.querySelector('#assistantStatusValue');
        const assistantStatusSubtitle = document.querySelector('#assistantStatusSubtitle');
        const knowledgeStatusValue = document.querySelector('#knowledgeStatusValue');
        const knowledgeStatusSubtitle = document.querySelector('#knowledgeStatusSubtitle');
        const sensitiveCard = document.querySelector('#sensitiveCard');
        const sensitiveCount = document.querySelector('#sensitiveCount');
        const knowledgeContent = data.knowledgeContent || '';
        const assistantActive = Boolean(data.settings?.assistantActive);

        if (assistantStatusValue) {
          assistantStatusValue.textContent = assistantActive ? 'Activo' : 'Inactivo';
        }
        if (assistantStatusSubtitle) {
          assistantStatusSubtitle.textContent = assistantActive
            ? 'Disponible para colaboradores'
            : 'Listo para activar cuando RR. HH. lo apruebe';
        }
        if (knowledgeStatusValue) {
          knowledgeStatusValue.textContent = knowledgeContent.trim().length > 0
            ? 'Con contenido'
            : 'Vacía';
        }
        if (knowledgeStatusSubtitle) {
          knowledgeStatusSubtitle.textContent = knowledgeContent.trim().length > 0
            ? `Última actualización: ${formatDate(data.knowledgeUpdatedAt)}`
            : 'Pendiente de carga oficial';
        }

        if (sensitiveCard && sensitiveCount) {
          const sensitiveValue = data.activity?.sensitiveCount;
          if (typeof sensitiveValue === 'number') {
            sensitiveCount.textContent = String(sensitiveValue);
            sensitiveCard.hidden = false;
          } else {
            sensitiveCard.hidden = true;
          }
        }
      }

      function updateChecklist() {
        const checklist = document.querySelector('#setupChecklist');
        if (!checklist) {
          return;
        }
        const settings = data.settings || {};
        const knowledgeContent = data.knowledgeContent || '';
        const hrEmail = settings.hrContact?.email?.trim() || '';
        const hrUrl = settings.hrContact?.url?.trim() || '';

        const completion = {
          knowledge: knowledgeContent.trim().length > 0,
          preview: previewReviewed,
          hr: Boolean(hrEmail || hrUrl),
          activation: Boolean(settings.assistantActive)
        };

        checklist.querySelectorAll('.checklist-item').forEach((step) => {
          const key = step.dataset.checkKey || step.dataset.stepLink;
          step.classList.toggle('completed', Boolean(completion[key]));
        });

        const activationText = document.querySelector('#activationChecklistText');
        if (activationText) {
          activationText.textContent = settings.assistantActive
            ? 'Helpin está activo para colaboradores'
            : 'Activar el asistente para colaboradores';
        }
      }

      function updateKnowledgeProgress() {
        const badge = document.querySelector('#knowledgeProgress');
        if (!badge) {
          return;
        }
        badge.textContent = (data.knowledgeContent || '').trim().length > 0
          ? 'Listo'
          : 'Pendiente';
      }

      function initKnowledgeEditor() {
        const textarea = document.querySelector('#knowledgeContent');
        if (!textarea) {
          return;
        }
        textarea.value = data.knowledgeContent || '';
        updateKnowledgeStatus();
        updateKnowledgeProgress();
        textarea.addEventListener('input', (event) => {
          data.knowledgeContent = event.target.value;
          data.knowledgeUpdatedAt = new Date().toISOString();
          markDirty();
          updateChecklist();
          updateKnowledgeStatus();
          updateKnowledgeProgress();
          refreshPreview();
        });
      }

      function initTemplates() {
        const buttons = document.querySelectorAll('[data-template]');
        const textarea = document.querySelector('#knowledgeContent');
        if (!buttons.length || !textarea) {
          return;
        }
        buttons.forEach((button) => {
          button.addEventListener('click', () => {
            const template = templates[button.dataset.template];
            if (!template) {
              return;
            }
            const current = textarea.value.trim();
            const nextValue = current ? `${current}\n\n${template}` : template;
            textarea.value = nextValue;
            data.knowledgeContent = nextValue;
            data.knowledgeUpdatedAt = new Date().toISOString();
            markDirty();
            updateChecklist();
            updateKnowledgeStatus();
            updateKnowledgeProgress();
            refreshPreview();
          });
        });
      }

      function replaceVariables(value) {
        if (!value) {
          return '';
        }
        const hrEmail = data.settings?.hrContact?.email || '';
        const hrUrl = data.settings?.hrContact?.url || '';
        return value
          .replace(/\{correo_rrhh\}/g, hrEmail)
          .replace(/\{url_rrhh\}/g, hrUrl);
      }

      function updateEscalationPreview() {
        const preview = document.querySelector('#hrEscalationPreview');
        if (!preview) {
          return;
        }
        const hrEmail = data.settings?.hrContact?.email || '{correo_rrhh}';
        const hrUrl = data.settings?.hrContact?.url || '{url_rrhh}';
        preview.textContent = `Correo: ${hrEmail} · URL: ${hrUrl}`;
      }

      function validateEmail(value) {
        if (!value) {
          return false;
        }
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
      }

      function updateActivationState() {
        const activationButton = document.querySelector('#activateAssistant');
        const deactivateButton = document.querySelector('#deactivateAssistant');
        const activationHint = document.querySelector('#activationHint');
        const conditionItems = document.querySelectorAll('#activationConditions li');
        const knowledgeReady = (data.knowledgeContent || '').trim().length > 0;
        const hrReady = validateEmail(data.settings?.hrContact?.email || '');
        const testsReady = testsExecuted > 0;
        const canActivate = knowledgeReady && hrReady;

        if (conditionItems.length >= 3) {
          conditionItems[0].classList.toggle('completed', knowledgeReady);
          conditionItems[1].classList.toggle('completed', hrReady);
          conditionItems[2].classList.toggle('completed', testsReady);
        }

        if (activationButton) {
          activationButton.disabled = !canActivate || data.settings?.assistantActive;
        }
        if (deactivateButton) {
          deactivateButton.hidden = !data.settings?.assistantActive;
        }
        if (activationHint) {
          if (data.settings?.assistantActive) {
            activationHint.textContent = 'El asistente está activo para colaboradores.';
          } else if (canActivate) {
            activationHint.textContent = 'Todo listo para activar.';
          } else {
            activationHint.textContent = 'Complete los requisitos obligatorios para activar.';
          }
        }
      }

      function updateMessagesPreview() {
        const preview = document.querySelector('#messagePreview');
        if (!preview) {
          return;
        }
        const noInfo = replaceVariables(data.settings?.noInfoMessage || '');
        const disclaimer = replaceVariables(data.settings?.disclaimer || '');
        preview.textContent = `Vista previa del mensaje: ${noInfo} · Nota: ${disclaimer}`;
      }

      function renderSettings() {
        const settings = data.settings;
        if (!settings) {
          return;
        }

        const hrEmailInput = document.querySelector('#hrEmail');
        const hrUrlInput = document.querySelector('#hrUrl');
        const hrEmailHint = document.querySelector('#hrEmailHint');
        const noInfoMessageTextarea = document.querySelector('#noInfoMessage');
        const disclaimerTextarea = document.querySelector('#assistantDisclaimer');
        const countryContextSelect = document.querySelector('#countryContext');

        if (hrEmailInput) {
          hrEmailInput.value = settings.hrContact.email;
          if (hrEmailHint) {
            const isValid = validateEmail(settings.hrContact.email.trim());
            hrEmailHint.textContent = isValid
              ? 'Correo válido.'
              : 'Campo obligatorio (use un correo válido).';
            hrEmailHint.classList.toggle('error', !isValid);
          }
          hrEmailInput.addEventListener('input', (event) => {
            settings.hrContact.email = event.target.value;
            markDirty();
            updateChecklist();
            updateEscalationPreview();
            updateActivationState();
            updateMessagesPreview();
            if (hrEmailHint) {
              const isValid = validateEmail(event.target.value.trim());
              hrEmailHint.textContent = isValid
                ? 'Correo válido.'
                : 'Campo obligatorio (use un correo válido).';
              hrEmailHint.classList.toggle('error', !isValid);
            }
          });
        }

        if (hrUrlInput) {
          hrUrlInput.value = settings.hrContact.url;
          hrUrlInput.addEventListener('input', (event) => {
            settings.hrContact.url = event.target.value;
            markDirty();
            updateChecklist();
            updateEscalationPreview();
            updateMessagesPreview();
          });
        }

        if (noInfoMessageTextarea) {
          const fallbackValue = settings.noInfoMessage || settings.hrContact.fallbackMessage || '';
          noInfoMessageTextarea.value = fallbackValue;
          settings.noInfoMessage = fallbackValue;
          settings.hrContact.fallbackMessage = fallbackValue;
          noInfoMessageTextarea.addEventListener('input', (event) => {
            settings.noInfoMessage = event.target.value;
            settings.hrContact.fallbackMessage = event.target.value;
            data.sampleResponses.fallback = event.target.value;
            markDirty();
            refreshPreview();
            updateMessagesPreview();
          });
        }

        if (disclaimerTextarea) {
          disclaimerTextarea.value = settings.disclaimer;
          disclaimerTextarea.addEventListener('input', (event) => {
            settings.disclaimer = event.target.value;
            markDirty();
            refreshPreview();
            updateMessagesPreview();
          });
        }

        if (countryContextSelect) {
          countryContextSelect.value = settings.countryContext;
          countryContextSelect.addEventListener('change', (event) => {
            settings.countryContext = event.target.value;
            markDirty();
            refreshPreview();
          });
        }

        const toneOptions = Array.from(
          document.querySelectorAll('input[name="tone"]')
        );
        toneOptions.forEach((option) => {
          option.checked = option.value === settings.tone;
          option.addEventListener('change', (event) => {
            if (event.target.checked) {
              settings.tone = event.target.value;
              markDirty();
            }
          });
        });

        const languageOptions = Array.from(
          document.querySelectorAll('input[name="assistantLanguage"]')
        );
        if (languageOptions.length) {
          const selectedLanguages = Array.isArray(settings.languages)
            ? settings.languages
            : settings.language
            ? [settings.language]
            : [];

          languageOptions.forEach((option) => {
            option.checked = selectedLanguages.includes(option.value);
            option.addEventListener('change', () => {
              settings.languages = languageOptions
                .filter((input) => input.checked)
                .map((input) => input.value);
              markDirty();
            });
          });
        }

        updateEscalationPreview();
        updateMessagesPreview();
      }

      function initBoundaries() {
        const boundaries = data.settings?.assistantBoundaries;
        if (!boundaries) {
          return;
        }

        const boundaryProfile = document.querySelector('#boundaryProfile');
        const boundaryOptions = document.querySelector('#boundaryOptions');
        const boundaryOfficialOnly = document.querySelector('#boundaryOfficialOnly');
        const boundaryPersonal = document.querySelector('#boundaryPersonal');
        const boundaryContracts = document.querySelector('#boundaryContracts');
        const boundaryLegal = document.querySelector('#boundaryLegal');
        const boundaryEscalate = document.querySelector('#boundaryEscalate');

        function applyBoundaryValues(values) {
          boundaries.onlyOfficialInfo = values.onlyOfficialInfo;
          boundaries.noPersonalCases = values.noPersonalCases;
          boundaries.noContractInterpretation = values.noContractInterpretation;
          boundaries.noLegalQuestions = values.noLegalQuestions;
          boundaries.alwaysEscalate = values.alwaysEscalate;

          if (boundaryOfficialOnly) {
            boundaryOfficialOnly.checked = boundaries.onlyOfficialInfo;
          }
          if (boundaryPersonal) {
            boundaryPersonal.checked = boundaries.noPersonalCases;
          }
          if (boundaryContracts) {
            boundaryContracts.checked = boundaries.noContractInterpretation;
          }
          if (boundaryLegal) {
            boundaryLegal.checked = boundaries.noLegalQuestions;
          }
          if (boundaryEscalate) {
            boundaryEscalate.checked = boundaries.alwaysEscalate;
          }
          markDirty();
          refreshPreview();
        }

        function updateProfileVisibility() {
          const isStrict = boundaryProfile?.value === 'strict';
          if (boundaryOptions) {
            boundaryOptions.style.display = isStrict ? 'none' : 'grid';
          }
          if (isStrict) {
            applyBoundaryValues(strictProfileValues);
          }
        }

        const isStrictDefault = Object.keys(strictProfileValues).every(
          (key) => boundaries[key] === strictProfileValues[key]
        );

        if (boundaryProfile) {
          boundaryProfile.value = isStrictDefault ? 'strict' : 'custom';
          boundaryProfile.addEventListener('change', updateProfileVisibility);
        }

        const toggleHandlers = [
          { element: boundaryOfficialOnly, key: 'onlyOfficialInfo' },
          { element: boundaryPersonal, key: 'noPersonalCases' },
          { element: boundaryContracts, key: 'noContractInterpretation' },
          { element: boundaryLegal, key: 'noLegalQuestions' },
          { element: boundaryEscalate, key: 'alwaysEscalate' }
        ];

        toggleHandlers.forEach(({ element, key }) => {
          if (!element) {
            return;
          }
          element.checked = boundaries[key];
          element.addEventListener('change', (event) => {
            boundaries[key] = event.target.checked;
            markDirty();
            refreshPreview();
          });
        });

        updateProfileVisibility();
      }

      function refreshPreview() {
        const previewContainer = document.querySelector('#previewChat');
        if (window.HelpinChat && previewContainer) {
          window.HelpinChat.initChat({
            container: previewContainer,
            data,
            mode: 'preview'
          });
        }
      }

      function normalize(text) {
        return text.toLowerCase();
      }

      function extractKeywords(message) {
        const parts = message.split(/\s+/);
        return parts
          .map((part) => part.replace(/[^a-zA-ZÁÉÍÓÚÜÑáéíóúüñ]/g, '').toLowerCase())
          .filter((word) => word.length > 3);
      }

      function hasRelevantKnowledge(message, content) {
        if (!content || !content.trim()) {
          return false;
        }
        const normalizedMessage = normalize(message);
        const normalizedContent = normalize(content);
        if (normalizedContent.includes(normalizedMessage)) {
          return true;
        }
        const keywords = extractKeywords(message);
        return keywords.some((keyword) => normalizedContent.includes(keyword));
      }

      function evaluateTest(question) {
        const knowledgeContent = data.knowledgeContent || '';
        if (!knowledgeContent.trim()) {
          return {
            status: 'warning',
            message: 'WARNING: Sin información oficial, derivación a RR. HH.'
          };
        }
        if (hasRelevantKnowledge(question, knowledgeContent)) {
          return {
            status: 'ok',
            message: 'OK: Respondió con información oficial disponible.'
          };
        }
        return {
          status: 'warning',
          message: 'WARNING: No hay info oficial, revisar derivación manualmente.'
        };
      }

      function updateTestsSummary() {
        const okCount = Array.from(testsState.values()).filter(
          (value) => value.status === 'ok'
        ).length;
        const warningCount = Array.from(testsState.values()).filter(
          (value) => value.status === 'warning'
        ).length;
        const failCount = Array.from(testsState.values()).filter(
          (value) => value.status === 'fail'
        ).length;

        document.querySelector('#testsExecuted').textContent = String(testsExecuted);
        document.querySelector('#testsOk').textContent = String(okCount);
        document.querySelector('#testsWarning').textContent = String(warningCount);
        document.querySelector('#testsFail').textContent = String(failCount);
        updateChecklist();
        updateActivationState();
      }

      function runSingleTest(test) {
        const result = evaluateTest(test.label);
        testsExecuted += 1;
        testsState.set(test.id, result);

        const statusBadge = document.querySelector(`[data-test-status="${test.id}"]`);
        const message = document.querySelector(`[data-test-message="${test.id}"]`);
        if (statusBadge) {
          statusBadge.textContent = result.status.toUpperCase();
          statusBadge.className = `test-status ${result.status}`;
        }
        if (message) {
          message.textContent = result.message;
        }
        updateTestsSummary();
      }

      async function runAllTests() {
        for (const test of tests) {
          runSingleTest(test);
          await new Promise((resolve) => window.setTimeout(resolve, 200));
        }
      }

      function initTests() {
        const grid = document.querySelector('#testsGrid');
        if (!grid) {
          return;
        }
        grid.innerHTML = '';
        tests.forEach((test) => {
          const item = document.createElement('div');
          item.className = 'test-item';

          const header = document.createElement('header');
          const title = document.createElement('strong');
          title.textContent = test.label;
          const status = document.createElement('span');
          status.className = 'test-status warning';
          status.textContent = 'PENDING';
          status.dataset.testStatus = test.id;
          header.append(title, status);

          const message = document.createElement('div');
          message.dataset.testMessage = test.id;
          message.textContent = test.type === 'sensitive'
            ? 'Revisar manualmente si la respuesta respeta límites.'
            : 'Listo para probar.';

          const button = document.createElement('button');
          button.type = 'button';
          button.className = 'secondary small';
          button.textContent = 'Ejecutar prueba';
          button.addEventListener('click', () => runSingleTest(test));

          item.append(header, message, button);
          grid.appendChild(item);
        });

        const runAllButton = document.querySelector('#runAllTests');
        if (runAllButton) {
          runAllButton.addEventListener('click', runAllTests);
        }
      }

      function setActiveStep(step) {
        activeStep = step;
        document.querySelectorAll('.wizard-step').forEach((panel) => {
          panel.classList.toggle('active', Number(panel.dataset.step) === step);
        });
        document.querySelectorAll('.wizard-stepper-item').forEach((item) => {
          item.classList.toggle('active', Number(item.dataset.step) === step);
        });
        document.querySelectorAll('[data-step-link]').forEach((button) => {
          button.classList.toggle('active', Number(button.dataset.stepLink) === step);
        });
        if (step === 3) {
          previewReviewed = true;
          updateChecklist();
        }
      }

      function initWizardNavigation() {
        document.querySelectorAll('[data-step-link]').forEach((button) => {
          button.addEventListener('click', () => {
            setActiveStep(Number(button.dataset.stepLink));
          });
        });

        document.querySelectorAll('[data-next-step]').forEach((button) => {
          button.addEventListener('click', () => {
            setActiveStep(Number(button.dataset.nextStep));
          });
        });

        document.querySelectorAll('[data-prev-step]').forEach((button) => {
          button.addEventListener('click', () => {
            setActiveStep(Number(button.dataset.prevStep));
          });
        });
      }

      function initActivation() {
        const activateButton = document.querySelector('#activateAssistant');
        const deactivateButton = document.querySelector('#deactivateAssistant');
        if (activateButton) {
          activateButton.addEventListener('click', () => {
            data.settings.assistantActive = true;
            markDirty();
            updateChecklist();
            updateStatusCards();
            updateActivationState();
          });
        }
        if (deactivateButton) {
          deactivateButton.addEventListener('click', () => {
            data.settings.assistantActive = false;
            markDirty();
            updateChecklist();
            updateStatusCards();
            updateActivationState();
          });
        }
      }

      function initShortcuts() {
        document.querySelectorAll('.wizard-checklist [data-step-link]').forEach((button) => {
          button.addEventListener('click', () => {
            setActiveStep(Number(button.dataset.stepLink));
          });
        });
      }

      function init() {
        updateSaveStatus();
        updateStatusCards();
        updateChecklist();
        initKnowledgeEditor();
        initTemplates();
        renderSettings();
        initBoundaries();
        initTests();
        initWizardNavigation();
        initActivation();
        initShortcuts();
        updateActivationState();
        refreshPreview();
        setActiveStep(activeStep);
        updateKnowledgeProgress();
      }

      window.addEventListener('DOMContentLoaded', init);

      // Validación mínima:
      // - Guardar conocimiento funciona (actualiza knowledgeContent y knowledgeUpdatedAt).
      // - Email RR. HH. funciona (validación simple y update de settings.hrContact.email).
      // - Activar respeta prerequisitos (knowledge + email).
      // - Perfil estricto setea toggles (strictProfileValues).
      // - Modo personalizado permite cambiarlos.
      // - Avanzado colapsa/expande (details#advancedOptions).
      // - Preview funciona (HelpinChat.initChat en modo preview).
      // - Pruebas guiadas se pueden ejecutar (runSingleTest/runAllTests).
    })();
  </script>
</body>
</html>
