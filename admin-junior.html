<!DOCTYPE html>
<html lang="es-CL">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Activación rápida · Helpin</title>
  <link rel="stylesheet" href="css/styles.css" />
  <style>
    .wizard-layout {
      display: grid;
      gap: 20px;
    }

    .wizard-stepper {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    .wizard-stepper-item {
      border-radius: 14px;
      padding: 12px 14px;
      background: #f8fafc;
      border: 1px solid rgba(15, 23, 42, 0.08);
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      color: #0f172a;
    }

    .wizard-stepper-item .step-number {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #0f172a;
      color: #fff;
      display: grid;
      place-items: center;
      font-size: 0.9rem;
    }

    .wizard-stepper-item.active {
      background: #0f172a;
      color: #fff;
    }

    .wizard-stepper-item.active .step-number {
      background: #fff;
      color: #0f172a;
    }

    .wizard-step {
      display: none;
      padding: 24px;
      border-radius: 18px;
      background: #fff;
      box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
    }

    .wizard-step.active {
      display: block;
    }

    .wizard-actions {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      margin-top: 24px;
      flex-wrap: wrap;
    }

    .wizard-actions .primary {
      min-width: 200px;
    }

    .example-button {
      padding: 8px 14px;
      border-radius: 12px;
      border: 1px solid rgba(15, 23, 42, 0.16);
      background: #fff;
      cursor: pointer;
      font-weight: 600;
    }

    .wizard-checklist {
      display: grid;
      gap: 8px;
      margin-top: 16px;
    }

    .wizard-checklist .checklist-item {
      background: #f8fafc;
      border: 1px solid rgba(15, 23, 42, 0.1);
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .wizard-checklist .checklist-item.completed {
      border-color: rgba(34, 197, 94, 0.6);
      background: rgba(34, 197, 94, 0.1);
    }

    .wizard-checklist .checkmark {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid rgba(15, 23, 42, 0.3);
      display: grid;
      place-items: center;
      font-size: 0.75rem;
      font-weight: 700;
      color: rgba(15, 23, 42, 0.6);
    }

    .activation-button {
      width: 100%;
      min-height: 52px;
      font-size: 1rem;
    }

    .helper-text {
      margin-top: 8px;
      font-size: 0.9rem;
      color: #64748b;
    }
  </style>
</head>
<body class="admin-ui">
  <header class="admin-topbar">
    <div class="topbar-logo">Helpin</div>
    <div class="topbar-actions">
      <div class="save-status" aria-live="polite">Guardado automático</div>
    </div>
  </header>

  <main class="page wizard-layout">
    <div class="wizard-stepper" aria-label="Progreso del asistente">
      <div class="wizard-stepper-item active" data-step="1">
        <span class="step-number">1</span>
        <span>Información oficial</span>
      </div>
      <div class="wizard-stepper-item" data-step="2">
        <span class="step-number">2</span>
        <span>Contacto RR. HH.</span>
      </div>
      <div class="wizard-stepper-item" data-step="3">
        <span class="step-number">3</span>
        <span>Vista previa</span>
      </div>
      <div class="wizard-stepper-item" data-step="4">
        <span class="step-number">4</span>
        <span>Activar</span>
      </div>
    </div>

    <section class="wizard-step active" data-step="1">
      <header>
        <h2>Paso 1 · Información oficial</h2>
        <p>El asistente responderá solo con lo que pegues aquí.</p>
      </header>
      <button class="example-button" type="button" id="insertExample">Insertar ejemplo (puede borrarlo luego)</button>
      <div class="knowledge-editor" style="margin-top: 12px;">
        <label class="sr-only" for="knowledgeContent">Información oficial</label>
        <textarea
          id="knowledgeContent"
          placeholder="Pegue aquí políticas internas, beneficios y procedimientos oficiales de RR. HH."
        ></textarea>
      </div>
      <div class="wizard-actions">
        <span></span>
        <button class="primary" type="button" data-next-step="2">Continuar</button>
      </div>
    </section>

    <section class="wizard-step" data-step="2">
      <header>
        <h2>Paso 2 · Contacto RR. HH.</h2>
        <p>Este correo se mostrará cuando el asistente no pueda responder.</p>
      </header>
      <div class="form-grid">
        <div>
          <label for="hrEmail">Correo de RR. HH.</label>
          <input id="hrEmail" type="email" placeholder="rrhh@empresa.com" required />
        </div>
      </div>
      <div class="wizard-actions">
        <button class="secondary" type="button" data-prev-step="1">Volver</button>
        <button class="primary" type="button" data-next-step="3">Continuar</button>
      </div>
    </section>

    <section class="wizard-step" data-step="3">
      <header>
        <h2>Paso 3 · Vista previa</h2>
        <p>Así lo verán los colaboradores.</p>
      </header>
      <div id="previewChat" class="preview-chat"></div>
      <div class="wizard-actions">
        <button class="secondary" type="button" data-prev-step="2">Volver</button>
        <button class="primary" type="button" data-next-step="4">Continuar</button>
      </div>
    </section>

    <section class="wizard-step" data-step="4">
      <header>
        <h2>Paso 4 · Activar</h2>
      </header>
      <div class="card">
        <h3>Checklist mínimo</h3>
        <div class="wizard-checklist" id="activationChecklist">
          <div class="checklist-item" data-check="knowledge">
            <span class="checkmark" aria-hidden="true">✓</span>
            <span>Información oficial cargada</span>
          </div>
          <div class="checklist-item" data-check="hr">
            <span class="checkmark" aria-hidden="true">✓</span>
            <span>Correo RR. HH. definido</span>
          </div>
        </div>
        <button class="primary activation-button" type="button" id="activateAssistant">Activar asistente para colaboradores</button>
        <p class="helper-text">Puede desactivarlo en cualquier momento.</p>
      </div>
      <div class="wizard-actions">
        <button class="secondary" type="button" data-prev-step="3">Volver</button>
        <button class="primary" type="button" data-next-step="1">Ir al inicio</button>
      </div>
    </section>
  </main>

  <script src="js/mockData.js"></script>
  <script src="js/router.js"></script>
  <script src="js/chat.js"></script>
  <script>
    (function () {
      const data = window.HelpinData;
      const strictProfileValues = {
        onlyOfficialInfo: true,
        noPersonalCases: true,
        noContractInterpretation: true,
        noLegalQuestions: true,
        alwaysEscalate: true
      };

      let activeStep = 1;

      function setFixedBoundaries() {
        if (!data.settings) {
          data.settings = {};
        }
        data.settings.assistantBoundaries = {
          ...strictProfileValues
        };
      }

      function validateEmail(value) {
        if (!value) {
          return false;
        }
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
      }

      function updateFallbackMessage() {
        const email = data.settings?.hrContact?.email?.trim();
        const safeEmail = email || 'rrhh@empresa.com';
        const message =
          `No tengo información oficial sobre este tema.\n` +
          `Para evitar errores, contacte a RR. HH. en ${safeEmail}.`;
        data.settings.noInfoMessage = message;
        data.sampleResponses.fallback = message;
      }

      function updateChecklist() {
        const checklist = document.querySelector('#activationChecklist');
        if (!checklist) {
          return;
        }
        const knowledgeReady = (data.knowledgeContent || '').trim().length > 0;
        const hrReady = validateEmail(data.settings?.hrContact?.email || '');
        checklist.querySelectorAll('.checklist-item').forEach((item) => {
          const key = item.dataset.check;
          const isReady = key === 'knowledge' ? knowledgeReady : hrReady;
          item.classList.toggle('completed', isReady);
        });

        const activateButton = document.querySelector('#activateAssistant');
        if (activateButton) {
          activateButton.disabled = !(knowledgeReady && hrReady);
          if (data.settings?.assistantActive) {
            activateButton.textContent = 'Asistente activo para colaboradores';
            activateButton.disabled = true;
          } else {
            activateButton.textContent = 'Activar asistente para colaboradores';
          }
        }
      }

      function initKnowledgeEditor() {
        const textarea = document.querySelector('#knowledgeContent');
        if (!textarea) {
          return;
        }
        textarea.value = data.knowledgeContent || '';
        textarea.addEventListener('input', (event) => {
          data.knowledgeContent = event.target.value;
          data.knowledgeUpdatedAt = new Date().toISOString();
          updateChecklist();
          refreshPreview();
        });
      }

      function initExampleButton() {
        const button = document.querySelector('#insertExample');
        const textarea = document.querySelector('#knowledgeContent');
        if (!button || !textarea) {
          return;
        }
        const example =
          `## Vacaciones\n` +
          `- 15 días hábiles al año para colaboradores con más de 1 año en la empresa.\n` +
          `- La solicitud debe enviarse con al menos 2 semanas de anticipación.\n\n` +
          `## Licencias médicas\n` +
          `- Enviar el certificado médico a RR. HH. dentro de las 48 horas.`;
        button.addEventListener('click', () => {
          const current = textarea.value.trim();
          const nextValue = current ? `${current}\n\n${example}` : example;
          textarea.value = nextValue;
          data.knowledgeContent = nextValue;
          data.knowledgeUpdatedAt = new Date().toISOString();
          updateChecklist();
          refreshPreview();
        });
      }

      function initContact() {
        if (!data.settings) {
          data.settings = {};
        }
        if (!data.settings.hrContact) {
          data.settings.hrContact = { email: '' };
        }

        const emailInput = document.querySelector('#hrEmail');
        if (!emailInput) {
          return;
        }
        emailInput.value = data.settings.hrContact.email || '';
        emailInput.addEventListener('input', (event) => {
          data.settings.hrContact.email = event.target.value;
          updateFallbackMessage();
          updateChecklist();
          refreshPreview();
        });
      }

      function refreshPreview() {
        const previewContainer = document.querySelector('#previewChat');
        if (!previewContainer || !window.HelpinChat) {
          return;
        }

        window.HelpinChat.initChat({
          container: previewContainer,
          data,
          mode: 'preview'
        });

        const body = previewContainer.querySelector('.chat-body');
        if (!body) {
          return;
        }

        body.innerHTML = '';
        const createMessage = (content, role) => {
          const message = document.createElement('div');
          message.className = `message ${role}`;
          message.textContent = content;
          return message;
        };

        const normalQuestion = '¿Cuántos días de vacaciones tengo?';
        const sensitiveQuestion = 'Tengo un tema personal delicado, ¿pueden ayudarme?';
        const hasKnowledge = (data.knowledgeContent || '').trim().length > 0;
        const normalResponse = hasKnowledge
          ? `Según la información oficial:\n${data.knowledgeContent.trim()}`
          : data.settings.noInfoMessage;
        const sensitiveResponse = data.settings.noInfoMessage;

        body.appendChild(createMessage(normalQuestion, 'user'));
        body.appendChild(createMessage(normalResponse, 'assistant'));
        body.appendChild(createMessage(sensitiveQuestion, 'user'));
        body.appendChild(createMessage(sensitiveResponse, 'assistant'));
      }

      function setActiveStep(step) {
        activeStep = step;
        document.querySelectorAll('.wizard-step').forEach((panel) => {
          panel.classList.toggle('active', Number(panel.dataset.step) === step);
        });
        document.querySelectorAll('.wizard-stepper-item').forEach((item) => {
          item.classList.toggle('active', Number(item.dataset.step) === step);
        });
      }

      function initWizardNavigation() {
        document.querySelectorAll('[data-next-step]').forEach((button) => {
          button.addEventListener('click', () => {
            setActiveStep(Number(button.dataset.nextStep));
          });
        });

        document.querySelectorAll('[data-prev-step]').forEach((button) => {
          button.addEventListener('click', () => {
            setActiveStep(Number(button.dataset.prevStep));
          });
        });
      }

      function initActivation() {
        const activateButton = document.querySelector('#activateAssistant');
        if (!activateButton) {
          return;
        }
        activateButton.addEventListener('click', () => {
          data.settings.assistantActive = true;
          updateChecklist();
        });
      }

      function init() {
        setFixedBoundaries();
        updateFallbackMessage();
        initKnowledgeEditor();
        initExampleButton();
        initContact();
        initWizardNavigation();
        initActivation();
        refreshPreview();
        updateChecklist();
        setActiveStep(activeStep);
      }

      window.addEventListener('DOMContentLoaded', init);
    })();
  </script>
</body>
</html>
