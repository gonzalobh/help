<!DOCTYPE html>
<html lang="es-CL">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Configuración simple de Helpin</title>
  <link rel="stylesheet" href="css/styles.css" />
  <style>
    .wizard-layout {
      display: grid;
      grid-template-columns: minmax(180px, 220px) minmax(0, 1fr);
      gap: 24px;
    }

    .wizard-secondary-nav {
      position: sticky;
      top: 96px;
      align-self: start;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
      border-radius: 16px;
      background: #fff;
      box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
    }

    .wizard-secondary-nav button {
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: transparent;
      padding: 10px 12px;
      border-radius: 12px;
      text-align: left;
      cursor: pointer;
      font-weight: 600;
      color: #0f172a;
    }

    .wizard-secondary-nav button.active {
      background: #0f172a;
      color: #fff;
    }

    .wizard-content {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .wizard-stepper {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    .wizard-stepper-item {
      border-radius: 14px;
      padding: 12px 14px;
      background: #f8fafc;
      border: 1px solid rgba(15, 23, 42, 0.08);
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      color: #0f172a;
    }

    .wizard-stepper-item .step-number {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #0f172a;
      color: #fff;
      display: grid;
      place-items: center;
      font-size: 0.9rem;
    }

    .wizard-stepper-item.active {
      background: #0f172a;
      color: #fff;
    }

    .wizard-stepper-item.active .step-number {
      background: #fff;
      color: #0f172a;
    }

    .wizard-step {
      display: none;
      padding: 24px;
      border-radius: 18px;
      background: #fff;
      box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
    }

    .wizard-step.active {
      display: block;
    }

    .wizard-step header {
      margin-bottom: 16px;
    }

    .wizard-actions {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      margin-top: 24px;
      flex-wrap: wrap;
    }

    .wizard-actions .primary {
      min-width: 160px;
    }

    .wizard-actions .secondary {
      min-width: 120px;
    }

    .activation-panel {
      display: grid;
      gap: 16px;
    }

    .activation-conditions {
      display: grid;
      gap: 8px;
      padding-left: 18px;
    }

    .activation-conditions li {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
    }

    .activation-conditions .checkmark {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid rgba(15, 23, 42, 0.2);
      display: grid;
      place-items: center;
      font-size: 0.75rem;
      color: rgba(15, 23, 42, 0.7);
    }

    .activation-conditions li.completed .checkmark {
      border-color: rgba(34, 197, 94, 0.6);
      color: #16a34a;
    }

    .activation-help {
      font-size: 0.9rem;
      color: #64748b;
    }

    .edit-notice {
      background: #fef9c3;
      color: #854d0e;
      border: 1px solid rgba(234, 179, 8, 0.4);
      padding: 12px 16px;
      border-radius: 12px;
      font-weight: 600;
    }

    .active-summary {
      display: grid;
      place-items: center;
      min-height: calc(100vh - 220px);
    }

    .summary-card {
      background: #fff;
      border-radius: 20px;
      padding: 32px;
      max-width: 520px;
      width: 100%;
      box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
      text-align: left;
      display: grid;
      gap: 20px;
    }

    .summary-card h2 {
      margin: 0;
    }

    .summary-list {
      display: grid;
      gap: 8px;
      color: #0f172a;
    }

    .summary-list span {
      color: #64748b;
      font-size: 0.9rem;
    }

    @media (max-width: 960px) {
      .wizard-layout {
        grid-template-columns: 1fr;
      }

      .wizard-secondary-nav {
        position: static;
        flex-direction: row;
        overflow-x: auto;
      }
    }
  </style>
</head>
<body class="admin-ui">
  <header class="admin-topbar">
    <div class="topbar-logo">Helpin</div>
    <div class="topbar-actions">
      <div class="save-status" id="saveStatus" aria-live="polite">✓ Guardado</div>
      <div>
        <a class="topbar-button small" id="employeeChatLink" href="chat.html" target="_blank" rel="noopener noreferrer">Ver como colaborador</a>
        <div class="employee-chat-note">Vista de prueba (no afecta datos reales).</div>
      </div>
    </div>
  </header>

  <main class="page">
    <section class="active-summary" id="activeSummary" hidden>
      <div class="summary-card">
        <div>
          <h2>Asistente de RR. HH. activo</h2>
          <p class="note">La configuración está completa y visible para colaboradores.</p>
        </div>
        <div class="summary-list">
          <div><strong>Estado:</strong> Activo</div>
          <div><strong>Información oficial:</strong> Cargada</div>
          <div><strong>Contacto RR. HH.:</strong> <span id="summaryHrEmail">—</span></div>
          <div><strong>Visible para colaboradores:</strong> Sí</div>
        </div>
        <button class="primary" type="button" id="editConfiguration">Editar configuración</button>
      </div>
    </section>

    <div class="wizard-layout" id="wizardLayout">
      <aside class="wizard-secondary-nav" id="wizardSidebar" aria-label="Navegación secundaria">
        <button type="button" class="active" data-step-link="1">Paso 1 · Información oficial</button>
        <button type="button" data-step-link="2">Paso 2 · Contacto RR. HH.</button>
        <button type="button" data-step-link="3">Paso 3 · Vista previa</button>
        <button type="button" data-step-link="4">Paso 4 · Activar</button>
      </aside>

      <div class="wizard-content">
        <div class="edit-notice" id="editNotice" hidden>Está editando una configuración activa</div>

        <div class="wizard-stepper" id="wizardStepper" aria-label="Progreso del asistente">
          <div class="wizard-stepper-item active" data-step="1">
            <span class="step-number">1</span>
            <span>Información oficial</span>
          </div>
          <div class="wizard-stepper-item" data-step="2">
            <span class="step-number">2</span>
            <span>Contacto RR. HH.</span>
          </div>
          <div class="wizard-stepper-item" data-step="3">
            <span class="step-number">3</span>
            <span>Vista previa</span>
          </div>
          <div class="wizard-stepper-item" data-step="4">
            <span class="step-number">4</span>
            <span>Activar</span>
          </div>
        </div>

        <section class="wizard-step active" data-step="1">
          <header>
            <h2>Paso 1 · Información oficial</h2>
            <p>Pegue la información oficial que el asistente podrá usar para responder.</p>
          </header>
          <div class="knowledge-editor">
            <label class="sr-only" for="knowledgeContent">Contenido de conocimiento</label>
            <textarea
              id="knowledgeContent"
              placeholder="Pegue aquí políticas internas, beneficios, procedimientos y textos oficiales de RR. HH."
            ></textarea>
            <div class="knowledge-status" id="knowledgeStatus">Sin contenido aún</div>
          </div>
          <div class="wizard-actions">
            <span class="badge" id="knowledgeProgress">Pendiente</span>
            <button class="primary" type="button" data-next-step="2">Continuar</button>
          </div>
        </section>

        <section class="wizard-step" data-step="2">
          <header>
            <h2>Paso 2 · Contacto RR. HH.</h2>
            <p>Defina el correo principal para derivar dudas o casos sensibles.</p>
          </header>
          <div class="form-grid">
            <div>
              <label for="hrEmail">Correo de RR. HH.</label>
              <input id="hrEmail" type="text" placeholder="ejemplo@empresa.com" />
              <div class="validation-hint" id="hrEmailHint">Campo obligatorio.</div>
            </div>
            <div>
              <label for="hrUrl">URL de contacto de RR. HH. (opcional)</label>
              <input id="hrUrl" type="text" placeholder="https://intranet.empresa.com/rrhh" />
            </div>
          </div>
          <div class="card">
            <h3>Este será el canal de escalamiento</h3>
            <p class="note" id="hrEscalationPreview">Correo y URL definidos.</p>
          </div>
          <div class="wizard-actions">
            <button class="secondary" type="button" data-prev-step="1">Volver</button>
            <button class="primary" type="button" data-next-step="3">Continuar</button>
          </div>
        </section>

        <section class="wizard-step" data-step="3">
          <header>
            <h2>Paso 3 · Vista previa</h2>
            <p>Revise cómo responderá el asistente con la información oficial cargada.</p>
          </header>
          <div id="previewChat" class="preview-chat"></div>
          <div class="wizard-actions">
            <button class="secondary" type="button" data-prev-step="2">Volver</button>
            <button class="primary" type="button" data-next-step="4">Continuar</button>
          </div>
        </section>

        <section class="wizard-step" data-step="4">
          <header>
            <h2>Paso 4 · Activar</h2>
            <p>Confirme los mínimos y active el asistente para colaboradores.</p>
          </header>
          <div class="activation-panel">
            <div class="card">
              <ul class="activation-conditions" id="activationConditions">
                <li><span class="checkmark">✓</span> Información oficial cargada</li>
                <li><span class="checkmark">✓</span> Correo RR. HH. definido</li>
              </ul>
              <button class="primary" type="button" id="activateAssistant">Activar asistente para colaboradores</button>
              <div class="activation-help">Puede desactivarlo o editarlo en cualquier momento.</div>
            </div>
          </div>
          <div class="wizard-actions">
            <button class="secondary" type="button" data-prev-step="3">Volver</button>
          </div>
        </section>
      </div>
    </div>
  </main>

  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="js/mockData.js"></script>
  <script src="js/router.js"></script>
  <script src="js/chat.js"></script>
  <script>
    (function () {
      const data = window.HelpinData;
      let activeStep = 1;
      let isDirty = false;
      let saveTimer = null;
      let isEditing = false;

      const fixedBoundaries = {
        onlyOfficialInfo: true,
        noPersonalCases: true,
        noContractInterpretation: true,
        noLegalQuestions: true,
        alwaysEscalate: true
      };

      function updateSaveStatus() {
        const status = document.querySelector('#saveStatus');
        if (!status) {
          return;
        }
        if (isDirty) {
          status.textContent = 'Cambios sin guardar';
          status.classList.add('unsaved');
        } else {
          status.textContent = '✓ Guardado';
          status.classList.remove('unsaved');
        }
      }

      function markDirty() {
        isDirty = true;
        updateSaveStatus();
        if (saveTimer) {
          window.clearTimeout(saveTimer);
        }
        saveTimer = window.setTimeout(() => {
          isDirty = false;
          updateSaveStatus();
        }, 1200);
      }

      function ensureFixedBoundaries() {
        if (!data.settings) {
          return;
        }
        if (!data.settings.assistantBoundaries) {
          data.settings.assistantBoundaries = {};
        }
        Object.assign(data.settings.assistantBoundaries, fixedBoundaries);
      }

      function validateEmail(value) {
        if (!value) {
          return false;
        }
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
      }

      function updateKnowledgeStatus() {
        const status = document.querySelector('#knowledgeStatus');
        const content = data.knowledgeContent || '';
        if (status) {
          status.textContent = content.trim().length > 0
            ? 'Contenido listo para usar.'
            : 'Sin contenido aún';
        }
      }

      function updateKnowledgeProgress() {
        const badge = document.querySelector('#knowledgeProgress');
        if (!badge) {
          return;
        }
        badge.textContent = (data.knowledgeContent || '').trim().length > 0
          ? 'Listo'
          : 'Pendiente';
      }

      function updateActivationChecklist() {
        const conditionItems = document.querySelectorAll('#activationConditions li');
        const knowledgeReady = (data.knowledgeContent || '').trim().length > 0;
        const hrReady = validateEmail(data.settings?.hrContact?.email || '');

        if (conditionItems.length >= 2) {
          conditionItems[0].classList.toggle('completed', knowledgeReady);
          conditionItems[1].classList.toggle('completed', hrReady);
        }

        const activateButton = document.querySelector('#activateAssistant');
        if (activateButton) {
          activateButton.disabled = !(knowledgeReady && hrReady) || Boolean(data.settings?.assistantActive);
        }
      }

      function updateSummary() {
        const summaryEmail = document.querySelector('#summaryHrEmail');
        if (summaryEmail) {
          summaryEmail.textContent = data.settings?.hrContact?.email || 'Sin definir';
        }
      }

      function updateEscalationPreview() {
        const preview = document.querySelector('#hrEscalationPreview');
        if (!preview) {
          return;
        }
        const hrEmail = data.settings?.hrContact?.email || '{correo_rrhh}';
        const hrUrl = data.settings?.hrContact?.url || '{url_rrhh}';
        preview.textContent = `Correo: ${hrEmail} · URL: ${hrUrl}`;
      }

      function renderMode() {
        const assistantActive = Boolean(data.settings?.assistantActive);
        const activeSummary = document.querySelector('#activeSummary');
        const wizardLayout = document.querySelector('#wizardLayout');
        const sidebar = document.querySelector('#wizardSidebar');
        const stepper = document.querySelector('#wizardStepper');
        const editNotice = document.querySelector('#editNotice');

        if (assistantActive && !isEditing) {
          if (activeSummary) {
            activeSummary.hidden = false;
          }
          if (wizardLayout) {
            wizardLayout.hidden = true;
          }
          if (sidebar) {
            sidebar.hidden = true;
          }
          if (stepper) {
            stepper.hidden = true;
          }
          if (editNotice) {
            editNotice.hidden = true;
          }
          updateSummary();
          return;
        }

        if (activeSummary) {
          activeSummary.hidden = true;
        }
        if (wizardLayout) {
          wizardLayout.hidden = false;
        }
        if (sidebar) {
          sidebar.hidden = false;
        }
        if (stepper) {
          stepper.hidden = false;
        }
        if (editNotice) {
          editNotice.hidden = !(assistantActive && isEditing);
        }
      }

      function setActiveStep(step) {
        activeStep = step;
        document.querySelectorAll('.wizard-step').forEach((panel) => {
          panel.classList.toggle('active', Number(panel.dataset.step) === step);
        });
        document.querySelectorAll('.wizard-stepper-item').forEach((item) => {
          item.classList.toggle('active', Number(item.dataset.step) === step);
        });
        document.querySelectorAll('[data-step-link]').forEach((button) => {
          button.classList.toggle('active', Number(button.dataset.stepLink) === step);
        });
      }

      function initWizardNavigation() {
        document.querySelectorAll('[data-step-link]').forEach((button) => {
          button.addEventListener('click', () => {
            setActiveStep(Number(button.dataset.stepLink));
          });
        });

        document.querySelectorAll('[data-next-step]').forEach((button) => {
          button.addEventListener('click', () => {
            setActiveStep(Number(button.dataset.nextStep));
          });
        });

        document.querySelectorAll('[data-prev-step]').forEach((button) => {
          button.addEventListener('click', () => {
            setActiveStep(Number(button.dataset.prevStep));
          });
        });
      }

      function initKnowledgeEditor() {
        const textarea = document.querySelector('#knowledgeContent');
        if (!textarea) {
          return;
        }
        textarea.value = data.knowledgeContent || '';
        updateKnowledgeStatus();
        updateKnowledgeProgress();
        textarea.addEventListener('input', (event) => {
          data.knowledgeContent = event.target.value;
          data.knowledgeUpdatedAt = new Date().toISOString();
          markDirty();
          updateKnowledgeStatus();
          updateKnowledgeProgress();
          updateActivationChecklist();
          refreshPreview();
        });
      }

      function renderSettings() {
        const settings = data.settings;
        if (!settings) {
          return;
        }

        const hrEmailInput = document.querySelector('#hrEmail');
        const hrUrlInput = document.querySelector('#hrUrl');
        const hrEmailHint = document.querySelector('#hrEmailHint');

        if (hrEmailInput) {
          hrEmailInput.value = settings.hrContact.email;
          if (hrEmailHint) {
            const isValid = validateEmail(settings.hrContact.email.trim());
            hrEmailHint.textContent = isValid
              ? 'Correo válido.'
              : 'Campo obligatorio (use un correo válido).';
            hrEmailHint.classList.toggle('error', !isValid);
          }
          hrEmailInput.addEventListener('input', (event) => {
            settings.hrContact.email = event.target.value;
            markDirty();
            updateEscalationPreview();
            updateActivationChecklist();
            updateSummary();
            if (hrEmailHint) {
              const isValid = validateEmail(event.target.value.trim());
              hrEmailHint.textContent = isValid
                ? 'Correo válido.'
                : 'Campo obligatorio (use un correo válido).';
              hrEmailHint.classList.toggle('error', !isValid);
            }
          });
        }

        if (hrUrlInput) {
          hrUrlInput.value = settings.hrContact.url;
          hrUrlInput.addEventListener('input', (event) => {
            settings.hrContact.url = event.target.value;
            markDirty();
            updateEscalationPreview();
          });
        }

        updateEscalationPreview();
      }

      function refreshPreview() {
        const previewContainer = document.querySelector('#previewChat');
        if (window.HelpinChat && previewContainer) {
          window.HelpinChat.initChat({
            container: previewContainer,
            data,
            mode: 'preview'
          });
        }
      }

      function initActivation() {
        const activateButton = document.querySelector('#activateAssistant');
        if (activateButton) {
          activateButton.addEventListener('click', () => {
            data.settings.assistantActive = true;
            isEditing = false;
            markDirty();
            updateActivationChecklist();
            updateSummary();
            renderMode();
          });
        }
      }

      function initEditMode() {
        const editButton = document.querySelector('#editConfiguration');
        if (editButton) {
          editButton.addEventListener('click', () => {
            isEditing = true;
            renderMode();
          });
        }
      }

      function init() {
        ensureFixedBoundaries();
        updateSaveStatus();
        initKnowledgeEditor();
        renderSettings();
        initWizardNavigation();
        initActivation();
        initEditMode();
        updateActivationChecklist();
        updateSummary();
        refreshPreview();
        setActiveStep(activeStep);
        renderMode();
      }

      window.addEventListener('DOMContentLoaded', init);
    })();
  </script>
</body>
</html>
